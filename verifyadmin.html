<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Mobilisation</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-blue-700 text-white p-4 flex justify-between items-center">
        <h1 class="text-xl font-bold">Admin Dashboard</h1>
        <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded hover:bg-red-600">Logout</button>
    </header>

    <!-- Filters -->
    <div class="p-4 bg-white shadow flex flex-wrap gap-4 items-center">
        <div>
            <label class="mr-2 font-semibold">Filter by Volunteer:</label>
            <select id="volunteerFilter" class="border rounded px-2 py-1">
                <option value="all">All</option>
                <option value="unassigned">Unassigned</option>
            </select>
        </div>
        <div>
            <input id="searchInput" type="text" placeholder="Search name, phone, email..."
                class="border rounded px-3 py-1 w-64">
        </div>
        <button id="refreshBtn" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
            Refresh
        </button>
        <button onclick="checkDuplicateCodes()" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">
            Check Duplicate Codes
        </button>
        <button onclick="printAllCodes()" class="bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700">
            Print Codes
        </button>
        <button onclick="saveAllChanges()" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
            Save All Changes
        </button>
    </div>

    <!-- Summary counts -->
    <div id="summary" class="p-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
        <div class="bg-white p-3 rounded shadow text-center">
            <p class="text-gray-500 text-sm">Total</p>
            <p id="countTotal" class="text-xl font-bold">0</p>
        </div>
        <div class="bg-white p-3 rounded shadow text-center">
            <p class="text-gray-500 text-sm">Registered</p>
            <p id="countRegistered" class="text-xl font-bold">0</p>
        </div>
        <div class="bg-white p-3 rounded shadow text-center">
            <p class="text-gray-500 text-sm">Confirmed</p>
            <p id="countConfirmed" class="text-xl font-bold">0</p>
        </div>
        <div class="bg-white p-3 rounded shadow text-center">
            <p class="text-gray-500 text-sm">Not Coming</p>
            <p id="countNotComing" class="text-xl font-bold">0</p>
        </div>
        <div class="bg-white p-3 rounded shadow text-center">
            <p class="text-gray-500 text-sm">Code Shared</p>
            <p id="countCodeShared" class="text-xl font-bold">0</p>
        </div>
    </div>

    <!-- Table -->
    <div class="p-4 overflow-x-auto flex-1">
        <table class="min-w-full border bg-white shadow">
            <thead class="bg-gray-200">
                <tr>
                    <th class="px-3 py-2 border">#</th>
                    <th class="px-3 py-2 border">Name</th>
                    <th class="px-3 py-2 border">Phone</th>
                    <th class="px-3 py-2 border">Email</th>
                    <th class="px-3 py-2 border">Code</th>
                    <th class="px-3 py-2 border">Status</th>
                    <th class="px-3 py-2 border">Volunteer</th>
                    <th class="px-3 py-2 border">Code Shared?</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <!-- Duplicate Codes Modal -->
    <div id="duplicateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow max-w-lg w-full">
            <h2 class="text-lg font-bold mb-4">Duplicate Codes Report</h2>
            <div id="duplicateList" class="max-h-64 overflow-y-auto text-sm"></div>
            <div id="unusedCodes" class="mt-4 p-2 bg-gray-100 rounded text-sm"></div>
            <div class="mt-4 flex justify-end">
                <button onclick="closeDuplicateModal()" class="bg-red-500 text-white px-3 py-1 rounded">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import {
            getFirestore, collection, getDocs, doc, updateDoc, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDEA64VWu2aELuNYuLvpu_QhdMuhYgNKZ0",
            authDomain: "arise-2d007.firebaseapp.com",
            projectId: "arise-2d007",
            storageBucket: "arise-2d007.firebasestorage.app",
            messagingSenderId: "243777013461",
            appId: "1:243777013461:web:d16ce794588d79662f045c"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const tableBody = document.getElementById("tableBody");
        const volunteerFilter = document.getElementById("volunteerFilter");
        const searchInput = document.getElementById("searchInput");

        let participants = [];

        // Fill volunteer filter options
        for (let i = 1; i <= 15; i++) {
            const opt = document.createElement("option");
            opt.value = "vol" + i;
            opt.textContent = "Volunteer " + i;
            volunteerFilter.appendChild(opt);
        }

        async function loadData() {
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4">Loading...</td></tr>`;
            const snapshot = await getDocs(collection(db, "registrations"));
            participants = snapshot.docs.map(ds => ({ id: ds.id, ...ds.data() }));

            renderTable();
        }

        function renderTable() {
            const filter = volunteerFilter.value;
            const search = searchInput.value.toLowerCase();

            let filtered = participants.filter(p => {
                let ok = true;
                if (filter !== "all") {
                    ok = (p.assignedVolunteer || "unassigned") === filter;
                }
                if (search) {
                    const text = `${p.name || ""} ${p.phone || ""} ${p.email || ""}`.toLowerCase();
                    ok = ok && text.includes(search);
                }
                return ok;
            });

            // update summary counts
            document.getElementById("countTotal").textContent = participants.length;
            document.getElementById("countRegistered").textContent =
                participants.filter(p => p.status === "registered").length;
            document.getElementById("countConfirmed").textContent =
                participants.filter(p => p.status === "confirmed").length;
            document.getElementById("countNotComing").textContent =
                participants.filter(p => p.status === "not_coming").length;
            document.getElementById("countCodeShared").textContent =
                participants.filter(p => p.codeShared === true).length;

            tableBody.innerHTML = "";
            if (filtered.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4">No results found</td></tr>`;
                return;
            }

            filtered.forEach((p, index) => {
                const row = document.createElement("tr");
                row.className = "hover:bg-gray-50";

                row.innerHTML = `
          <td class="border px-3 py-2 text-center">${index + 1}</td>
          <td class="border px-3 py-2"><input value="${p.name || ""}" data-id="${p.id}" data-field="name" class="border rounded px-1 py-0.5 w-full"></td>
          <td class="border px-3 py-2"><input value="${p.phone || ""}" data-id="${p.id}" data-field="phone" class="border rounded px-1 py-0.5 w-full"></td>
          <td class="border px-3 py-2"><input value="${p.email || ""}" data-id="${p.id}" data-field="email" class="border rounded px-1 py-0.5 w-full"></td>
          <td class="border px-3 py-2"><input value="${p.code || ""}" data-id="${p.id}" data-field="code" class="border rounded px-1 py-0.5 w-full"></td>
          <td class="border px-3 py-2">
            <select data-id="${p.id}" data-field="status" class="border rounded px-1 py-0.5 w-full">
              <option value="">--</option>
              <option value="registered" ${p.status === "registered" ? "selected" : ""}>Registered</option>
              <option value="confirmed" ${p.status === "confirmed" ? "selected" : ""}>Confirmed</option>
              <option value="not_coming" ${p.status === "not_coming" ? "selected" : ""}>Not Coming</option>
            </select>
          </td>
          <td class="border px-3 py-2">
            <select data-id="${p.id}" data-field="assignedVolunteer" class="border rounded px-1 py-0.5 w-full">
              <option value="">Unassigned</option>
              ${Array.from({ length: 15 }, (_, i) => {
                    const v = "vol" + (i + 1);
                    return `<option value="${v}" ${p.assignedVolunteer === v ? "selected" : ""}>${v}</option>`;
                }).join("")}
            </select>
          </td>
          <td class="border px-3 py-2 text-center">
            <input type="checkbox" data-id="${p.id}" data-field="codeShared" ${p.codeShared ? "checked" : ""}>
          </td>
        `;

                tableBody.appendChild(row);
            });
        }

        // Generate unique 4-digit numeric code
        function generateCode() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        // Save all changes
        async function saveAllChanges() {
            const inputs = document.querySelectorAll("[data-field]");
            const batch = writeBatch(db);

            const updates = {};
            inputs.forEach(el => {
                const id = el.dataset.id;
                const field = el.dataset.field;
                let val = el.type === "checkbox" ? el.checked : el.value.trim();
                if (val === "") val = null;
                if (!updates[id]) updates[id] = {};
                updates[id][field] = val;
            });

            // ensure codes are unique 4-digit
            const existingCodes = new Set(
                Object.values(updates).map(u => u.code).filter(Boolean)
            );

            for (const [id, update] of Object.entries(updates)) {
                if (update.code === null || update.code === "" || existingCodes.size !== new Set(existingCodes).size) {
                    let newCode;
                    do {
                        newCode = generateCode();
                    } while (existingCodes.has(newCode));
                    update.code = newCode;
                    existingCodes.add(newCode);
                }
                batch.update(doc(db, "registrations", id), update);
            }

            tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4">Saving all changes...</td></tr>`;
            await batch.commit();
            await loadData();
            alert("All changes saved successfully!");
        }
        window.saveAllChanges = saveAllChanges;

        // Check duplicate codes
        function checkDuplicateCodes() {
            const duplicateList = document.getElementById("duplicateList");
            const unusedCodes = document.getElementById("unusedCodes");

            duplicateList.innerHTML = `<div class="flex items-center gap-2 text-blue-600"><span class="animate-spin">⏳</span> Checking codes...</div>`;
            unusedCodes.innerHTML = "";

            setTimeout(() => {
                const codesMap = {};
                const duplicates = [];

                participants.forEach(p => {
                    if (p.code) {
                        if (!codesMap[p.code]) {
                            codesMap[p.code] = [];
                        }
                        codesMap[p.code].push(p);
                    }
                });

                for (const [code, list] of Object.entries(codesMap)) {
                    if (list.length > 1) {
                        duplicates.push({ code, list });
                    }
                }

                duplicateList.innerHTML = "";
                if (duplicates.length === 0) {
                    duplicateList.innerHTML = `<p class="text-green-600">No duplicate codes found ✅</p>`;
                } else {
                    duplicates.forEach(d => {
                        const div = document.createElement("div");
                        div.className = "mb-2";
                        div.innerHTML = `<p class="font-semibold text-red-600">Code: ${d.code} (x${d.list.length})</p>
              <ul class="list-disc list-inside">${d.list.map(p => `<li>${p.name} - ${p.phone}</li>`).join("")}</ul>`;
                        duplicateList.appendChild(div);
                    });
                }

                // Generate 10 unused 4-digit codes
                const existingCodes = new Set(participants.map(p => p.code).filter(Boolean));
                const newCodes = [];
                while (newCodes.length < 10) {
                    const code = generateCode();
                    if (!existingCodes.has(code)) {
                        newCodes.push(code);
                    }
                }

                unusedCodes.innerHTML = `
          <p class="font-semibold mb-1">Suggested Unused Codes:</p>
          <div class="grid grid-cols-2 gap-2">
            ${newCodes.map(c => `<span class="px-2 py-1 bg-green-100 border rounded">${c}</span>`).join("")}
          </div>
        `;
            }, 800);
            document.getElementById("duplicateModal").classList.remove("hidden");
        }
        window.checkDuplicateCodes = checkDuplicateCodes;

        // Print / Copy all unique codes
        function printAllCodes() {
            const codes = participants.map(p => p.code).filter(Boolean);
            if (codes.length === 0) {
                alert("No codes found in database.");
                return;
            }
            const uniqueCodes = [...new Set(codes)];
            navigator.clipboard.writeText(uniqueCodes.join("\n"))
                .then(() => {
                    alert("All unique codes copied to clipboard!\n\n" + uniqueCodes.join("\n"));
                })
                .catch(err => {
                    console.error("Clipboard copy failed:", err);
                    alert("Failed to copy codes.");
                });
        }
        window.printAllCodes = printAllCodes;

        function closeDuplicateModal() {
            document.getElementById("duplicateModal").classList.add("hidden");
        }
        window.closeDuplicateModal = closeDuplicateModal;

        // Event listeners
        volunteerFilter.addEventListener("change", renderTable);
        searchInput.addEventListener("input", renderTable);
        document.getElementById("refreshBtn").addEventListener("click", loadData);

        // Load initial
        loadData();

        // Logout
        function logout() {
            window.location.href = "mobilisation.html";
        }
        window.logout = logout;
    </script>
</body>

</html>
