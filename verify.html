<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Participant Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md bg-white p-6 sm:p-8 rounded-lg shadow-lg">
        <h1 class="text-xl sm:text-2xl font-bold text-center text-blue-700 mb-6">
            Verify Your Registration
        </h1>

        <!-- Input Section -->
        <div id="formSection" class="flex flex-col gap-3">
            <input id="codeInput" type="text" placeholder="Enter your unique code"
                class="w-full border rounded-lg px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500" />

            <button id="verifyBtn"
                class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                Search
            </button>
            <p id="errorMsg" class="text-red-600 text-sm hidden text-center">Invalid code. Please try again.</p>
            <p id="offlineMsg" class="text-orange-600 text-sm hidden text-center">⚠️ Offline: using cached data.</p>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="hidden mt-6">
            <div class="bg-blue-50 border-l-4 border-blue-600 p-4 rounded-lg">
                <h2 class="text-lg sm:text-xl font-bold mb-3 text-blue-700">Participant Profile</h2>
                <div class="space-y-2 text-sm sm:text-base">
                    <p><span class="font-semibold">Name:</span> <span id="resName"></span></p>
                    <p><span class="font-semibold">Phone:</span> <a id="resPhone" href="#"
                            class="text-blue-600 underline break-all"></a></p>
                    <p><span class="font-semibold">Email:</span> <span id="resEmail" class="break-all"></span></p>
                    <p><span class="font-semibold">Code:</span> <span id="resCode"></span></p>
                    <p><span class="font-semibold">Status:</span> <span id="resStatus"></span></p>
                    <p><span class="font-semibold">Assigned Volunteer:</span> <span id="resVolunteer"></span></p>
                    <p><span class="font-semibold">Code Shared:</span> <span id="resShared"></span></p>
                    <p><span class="font-semibold">Attendance:</span> <span id="resAttendance"></span></p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-5 flex flex-col sm:flex-row gap-3">
                <button id="attendanceBtn"
                    class="flex-1 bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700">
                    Mark Verified
                </button>
                <button onclick="resetForm()"
                    class="flex-1 bg-gray-600 text-white py-3 rounded-lg font-medium hover:bg-gray-700">
                    Verify Another
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDEA64VWu2aELuNYuLvpu_QhdMuhYgNKZ0",
            authDomain: "arise-2d007.firebaseapp.com",
            projectId: "arise-2d007",
            storageBucket: "arise-2d007.firebasestorage.app",
            messagingSenderId: "243777013461",
            appId: "1:243777013461:web:d16ce794588d79662f045c"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const verifyBtn = document.getElementById("verifyBtn");
        const codeInput = document.getElementById("codeInput");
        const errorMsg = document.getElementById("errorMsg");
        const offlineMsg = document.getElementById("offlineMsg");
        const formSection = document.getElementById("formSection");
        const resultSection = document.getElementById("resultSection");
        const attendanceBtn = document.getElementById("attendanceBtn");

        let currentDocId = null;
        let currentData = null;
        let cachedData = [];

        const resName = document.getElementById("resName");
        const resPhone = document.getElementById("resPhone");
        const resEmail = document.getElementById("resEmail");
        const resCode = document.getElementById("resCode");
        const resStatus = document.getElementById("resStatus");
        const resVolunteer = document.getElementById("resVolunteer");
        const resShared = document.getElementById("resShared");
        const resAttendance = document.getElementById("resAttendance");

        // Load data on startup
        async function loadData() {
            try {
                const snapshot = await getDocs(collection(db, "registrations"));
                const allData = [];
                snapshot.forEach(docSnap => {
                    allData.push({ id: docSnap.id, ...docSnap.data() });
                });

                localStorage.setItem("registrations", JSON.stringify(allData));
                cachedData = allData;
                console.log("✅ Data loaded from Firestore");
                offlineMsg.classList.add("hidden");
            } catch (err) {
                console.warn("⚠️ Could not fetch from Firestore, using local cache.");
                const local = localStorage.getItem("registrations");
                if (local) {
                    cachedData = JSON.parse(local);
                    offlineMsg.classList.remove("hidden");
                } else {
                    cachedData = [];
                    alert("⚠️ No local data available. Please connect to the internet once to sync.");
                }
            }
        }

        await loadData();

        // Search participant
        verifyBtn.addEventListener("click", () => {
            const enteredCode = codeInput.value.trim();
            if (!enteredCode) return;

            errorMsg.classList.add("hidden");

            let found = null;
            for (const item of cachedData) {
                if (item.code && item.code.toLowerCase() === enteredCode.toLowerCase()) {
                    found = item;
                    break;
                }
            }

            if (found) {
                currentData = found;
                currentDocId = found.id;

                resName.textContent = found.name || "";
                resPhone.textContent = found.phone || "";
                resPhone.href = found.phone ? `tel:${found.phone}` : "#";
                resEmail.textContent = found.email || "";
                resCode.textContent = found.code || "";
                resStatus.textContent = found.status || "Registered";
                resVolunteer.textContent = found.assignedVolunteer || "Not Assigned";
                resShared.textContent = found.codeShared ? "✅ Yes" : "❌ No";
                resAttendance.textContent = found.attendance === "present" ? "✅ Already Verified" : "❌ Not Verified";

                if (found.attendance === "present") {
                    attendanceBtn.disabled = true;
                    attendanceBtn.classList.add("bg-gray-400", "cursor-not-allowed");
                    attendanceBtn.textContent = "Already Verified";
                } else {
                    attendanceBtn.disabled = false;
                    attendanceBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
                    attendanceBtn.textContent = "Mark Verified";
                }

                formSection.classList.add("hidden");
                resultSection.classList.remove("hidden");
            } else {
                errorMsg.classList.remove("hidden");
            }
        });

        // Mark attendance
        attendanceBtn.addEventListener("click", async () => {
            if (!currentDocId) return;

            // Try Firestore update
            try {
                await updateDoc(doc(db, "registrations", currentDocId), {
                    attendance: "present"
                });
            } catch (e) {
                console.warn("⚠️ Could not update Firestore, updating cache only.");
            }

            // Update local cache
            cachedData = cachedData.map(item =>
                item.id === currentDocId ? { ...item, attendance: "present" } : item
            );
            localStorage.setItem("registrations", JSON.stringify(cachedData));

            resAttendance.textContent = "✅ Already Verified";
            attendanceBtn.disabled = true;
            attendanceBtn.classList.add("bg-gray-400", "cursor-not-allowed");
            attendanceBtn.textContent = "Already Verified";
            alert("Participant verified successfully ✅ (Saved offline too)");
        });

        // Reset form
        window.resetForm = function () {
            codeInput.value = "";
            currentDocId = null;
            currentData = null;
            formSection.classList.remove("hidden");
            resultSection.classList.add("hidden");
            errorMsg.classList.add("hidden");
        }
    </script>
</body>

</html>
